# 2021年总结

2021年开始从事了React-Native的工作。

主要使用语言是JavaScript，也是第一次实战接触React-Native混合开发（之前也写过2-3个月Flutter不过时间太短了，就不提了）。


React-Native相对于Objective-C、Swift原生开发来说，确实在搭建页面代码实现上，较为迅速（不与SwiftUI对比）

尽管React-Native底层是用原生组件来进行开发的，仍然会感觉到在渲染方面不如原生体验来得好。

React-Native是使用JSC+原生组件的方式进行渲染

# 启动流程

1.Native初始化
ReactNativeHost -> Activity -> ReactRootView -> startReactApplication -> createReactContextInBackground(期间有模块/UI组件信息收集、JSC初始化工作等)

2.后台异步加载，执行JSBundle

3.Native端执行setupReactContext初始化上下文，调用JS端AppRegister.runApplication(key, params)，key为模块/组件名称，参数包含rootTag，initialProps

4.JS端找到注册的对应启动组件，执行renderApplication渲染整个应用

![](https://upload-images.jianshu.io/upload_images/2979416-bdfcaea0dd9093d5.png)

renderApplication函数中会执行

```
ReactNative.render(
  <AppContainer>
    <RootComponent
      {...initialProps}
      rootTag={rootTag}
    />
  </AppContainer>,
  rootTag
);
```

其中ReactNative是在React库中定义的，AppContainer是一个JS组件，使用View包括了根组件，开发时工具Inspector、YellowBox都是在这个组件中加载的，RootComponent是传入的根组件。

# JS端注册组件（在第二步执行JSBundle时）

```
AppRegister.registerComponent(key, params)
```

* 仅在JS端处理，记录在一个Map中

Android端定义启动组件，Activity中，继承ReactActivity（在第一步时调用）

```
@Override
protected String getMainComponentName() {
  return "TiebaNext";
}
```

iOS端定义启动组件

```
self.rctRootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation
                                        moduleName:@"TiebaNext"
                                        initialProperties:nil
                                        launchOptions:nil];
```

简单来说就是Native初始化 -> 加载JS，JS端注册组件 -> 端上调用JS端run方法，传入入口组件名称 -> JS端启动渲染流程

# React-Native渲染流程

## 实例化

- getDefaultProps

组件类型首次实例化时初始化默认props属性，多实例共享

- getInitialState

实例化时初始化默认state属性

- componentWillMount

在渲染之前触发一次

- render

渲染函数，返回DOM树结构

- componentDidMount

在渲染之后触发一次

## 重渲染逻辑

- componentWillReceiveProps

组件接收到新的props时调用，并将其作为参数nextProps使用，可在此更改组件state

- shouldComponentUpdate

判断是否需要更新组件，在首次渲染期间或者调用了forceUpdate方法后，该方法不会被调用

- componentWillUpdate

更新渲染前调用

- render

渲染函数，返回DOM树结构

- componentDidUpdate

更新渲染后调用

# 销毁

- componentWillUnmount

组件移除之前调用

# 组件是如何渲染？
